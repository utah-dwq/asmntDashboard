
```{r, echo=F}
# Import assessments
library(wqTools)
library(leaflet)
setwd('C:\\Users\\jvander\\Documents\\R\\asmntDashboard')
site_use_param_asmnt=read.csv('data/site-use-param-asmnt.csv')


# Site level rollups
site_param_asmnt=irTools::rollUp(list(site_use_param_asmnt), group_vars=c('IR_MLID','IR_MLNAME','IR_Lat','IR_Long','ASSESS_ID','AU_NAME','R3172ParameterName'), cat_var="AssessCat", print=F, expand_uses=F)
site_asmnt=irTools::rollUp(list(site_use_param_asmnt), group_vars=c('IR_MLID','IR_MLNAME','IR_Lat','IR_Long','ASSESS_ID','AU_NAME'), cat_var="AssessCat", print=F, expand_uses=F)

## Generate impaired params wide list
sites_ns=subset(site_param_asmnt, AssessCat=='NS')
impaired_params=reshape2::dcast(IR_MLID~R3172ParameterName, data=sites_ns, value.var='R3172ParameterName')
nms=names(impaired_params[2:dim(impaired_params)[2]])
impaired_params=tidyr::unite(impaired_params, 'Impaired_params', nms, sep='; ')
impaired_params=within(impaired_params, {
	Impaired_params=gsub('NA; ', '', Impaired_params)
	Impaired_params=gsub('NA', '', Impaired_params)
	Impaired_params=sub("; $","",Impaired_params)
})
head(impaired_params)

## Generate idE params wide list
sites_idE=subset(site_param_asmnt, AssessCat=='idE')
idE_params=reshape2::dcast(IR_MLID~R3172ParameterName, data=sites_idE, value.var='R3172ParameterName')
nms=names(idE_params[2:dim(idE_params)[2]])
idE_params=tidyr::unite(idE_params, 'idE_params', nms, sep='; ')
idE_params=within(idE_params, {
	idE_params=gsub('NA; ', '', idE_params)
	idE_params=gsub('NA', '', idE_params)
	idE_params=sub("; $","",idE_params)
})
head(idE_params)

## Merge NS params & idE params to site assessments
site_asmnt=merge(site_asmnt, impaired_params, all.x=T)
site_asmnt=merge(site_asmnt, idE_params, all.x=T)
head(site_asmnt)


# AU level rollups
au_param_asmnt=irTools::rollUp(list(site_use_param_asmnt), group_vars=c('ASSESS_ID','AU_NAME','R3172ParameterName'), cat_var="AssessCat", print=F, expand_uses=F)
au_asmnt=irTools::rollUp(list(site_use_param_asmnt), group_vars=c('ASSESS_ID','AU_NAME'), cat_var="AssessCat", print=F, expand_uses=F)

## Generate impaired params wide list
aus_ns=subset(au_param_asmnt, AssessCat=='NS')
impaired_params=reshape2::dcast(ASSESS_ID~R3172ParameterName, data=aus_ns, value.var='R3172ParameterName')
nms=names(impaired_params[2:dim(impaired_params)[2]])
impaired_params=tidyr::unite(impaired_params, 'Impaired_params', nms, sep='; ')
impaired_params=within(impaired_params, {
	Impaired_params=gsub('NA; ', '', Impaired_params)
	Impaired_params=gsub('NA', '', Impaired_params)
	Impaired_params=sub("; $","",Impaired_params)
})
head(impaired_params)

## Generate idE params wide list
aus_idE=subset(au_param_asmnt, AssessCat=='idE')
idE_params=reshape2::dcast(ASSESS_ID~R3172ParameterName, data=aus_idE, value.var='R3172ParameterName')
nms=names(idE_params[2:dim(idE_params)[2]])
idE_params=tidyr::unite(idE_params, 'idE_params', nms, sep='; ')
idE_params=within(idE_params, {
	idE_params=gsub('NA; ', '', idE_params)
	idE_params=gsub('NA', '', idE_params)
	idE_params=sub("; $","",idE_params)
})
head(idE_params)


## Merge NS params & idE params to au assessments
au_asmnt=merge(au_asmnt, impaired_params, all.x=T)
au_asmnt=merge(au_asmnt, idE_params, all.x=T)
head(au_asmnt)


assignAsmntCols=function(x){
	y=within(x, {
		col=NA
		col[is.na(AssessCat)]='grey'
		col[AssessCat=='FS']='green'
		col[AssessCat=='idNE']='yellow'
		col[AssessCat=='idE']='orange'
		col[AssessCat=='NS']='red'
	})
	return(y)
}


data("au_poly")
data("bu_poly")
data("ss_poly")

au_poly=merge(au_poly, au_asmnt, all.x=T)
au_poly=assignAsmntCols(au_poly)
site_asmnt=assignAsmntCols(site_asmnt)


assessment_map=
buildMap(plot_polys = F) %>%
	leaflet::addCircleMarkers(data=site_asmnt, lat=~IR_Lat, lng=~IR_Long, group="Sites", 
		color = ~col, opacity=0.8, layerId=site_asmnt$IR_MLID, options = pathOptions(pane = "markers"),
		popup = paste0(
			"IR MLID: ", site_asmnt$IR_MLID,
			"<br> IR MLNAME: ", site_asmnt$IR_MLNAME,
			"<br> Assessment: ", site_asmnt$AssessCat,
			"<br> Impaired params: ", site_asmnt$Impaired_params,
			"<br> ID w/ exceedance params: ", site_asmnt$idE_params)
	) %>%	
	addPolygons(data=bu_poly,group="Beneficial uses",smoothFactor=4,fillOpacity = 0.1,weight=3,color="green", options = pathOptions(pane = "underlay_polygons"),
		popup=paste0(
			"Description: ", bu_poly$R317Descrp,
			"<br> Uses: ", bu_poly$bu_class)
	) %>%
	addPolygons(data=au_poly,group="Assessment units",smoothFactor=4,fillOpacity = 0.1, layerId=au_poly$ASSESS_ID,weight=3,color=~col, options = pathOptions(pane = "au_poly"),
		popup=paste0(
			"AU name: ", au_poly$AU_NAME,
			"<br> AU ID: ", au_poly$ASSESS_ID,
			"<br> Assessment: ", au_poly$AssessCat,
			"<br> Impaired params: ", au_poly$Impaired_params,
			"<br> ID w/ exceedance params: ", au_poly$idE_params)
	) %>%
	addPolygons(data=ss_poly,group="Site-specific standards",smoothFactor=4,fillOpacity = 0.1,weight=3,color="blue", options = pathOptions(pane = "underlay_polygons"),
		popup=paste0("SS std: ", ss_poly$SiteSpecif)
	) %>%
	leaflet::addLayersControl(position ="topleft",
		baseGroups = c("Topo","Satellite"),overlayGroups = c("Sites", "Assessment units","Beneficial uses", "Site-specific standards"),
		options = leaflet::layersControlOptions(collapsed = TRUE, autoZIndex=FALSE)) %>%
	#hideGroup("Assessment units") %>%
	hideGroup("Site-specific standards") %>%
	hideGroup("Beneficial uses") %>%
	hideGroup("Sites") %>%
	leaflet::addLegend(position = 'topright',
				colors = c('green','yellow','orange','red','grey'), 
				labels = c('Fully supporting', 'Insufficient data, no exceedances', 'Insufficient data, exceedances', 'Not supporting', 'Not assessed'))



assessment_map

htmlwidgets::saveWidget(assessment_map, 'assessment-map.html')
rsconnect::deployDoc('assessment-map.html', account='jakevl')

```




